---
title: "4-3-water-level"
output: html_document
---

## River level data in Victoria water gauges

Bureau of Meteorology collects [water data](http://www.bom.gov.au/metadata/catalogue/19115/ANZCW0503900528?template=full) from river gauges and this includes variables: electrical conductivity, turbidity, watercourse discharge, watercourse level, and water temperature. In particular, water level will interact with precipitation from the climate data since rainfall will raise the water level in the river. Figure \ref{fig:matching-map} gives the location of available weather stations and water gauges in Victoria.

```{r}
climate <- weatherdata::climate_full |>
  filter(between(stringr::str_sub(id, 7, 8), 76, 90)) |>
  face_temporal() |>
  filter(lubridate::year(date) == 2020) |>
  face_spatial() |>
  mutate(type = "climate")

river <- river |> mutate(type = "river")
```

```{r matching-map, out.width="100%", fig.cap="Location of weather stations and river gauges in Victoria, Australia."}
knitr::include_graphics(here::here("figures/matching-map.png"))
```

From the map, a few water gauges and weather stations are close to each other and the fluctuation of the water level could be matched up with precipitation measured by the climate station. As introduced in Section 3.2, \code{match_sites()} can be used to match one source of data with another source in a cubble. Here \code{Water_course_level} in \code{river} will be matched to \code{prcp} in \code{climate} in 2020. The two datasets need to be specified as the first two arguments and the variable to match can be specified in \code{temporal_by} using the \code{by} syntax in \code{join}. \code{temporal_independent} controls the variable used to construct the interval and the goal here is to see if the water level in the river will reflect precipitation. This puts precipitation \code{prcp}, as the independent. Given there is one year's worth of data, the number of peaks (\code{temporal_n_highest}) to consider is slightly raised from a default of 20 to 30 and \code{temporal_min_match} is raised accordingly To return all the pairs of the match, \code{temporal_min_match} can be set to 0.

```{r echo = TRUE}
res <- match_sites(
  river, climate,
  temporal_by = c("Water_course_level" = "prcp"),
  temporal_independent = "prcp",  
  temporal_n_highest = 30,
  temporal_min_match = 15
)
```

The output from matching is also a cubble, with additional column \code{dist} and \code{group} produced from spatial matching and \code{n_match} from temporal matching. 

```{r}
res |> print(n = 8)
```

Figure \ref{fig:matching} plots the matched pairs on the map or to view the matched series. There are four pairs of matches, all located in the middle of Victoria and the concurrent increase in precipitation and water level can be observed.

```{r matching, out.width="100%", fig.cap="Matched weather stations and river gauges on the map (A) and across time (B). Precipitation and water level have been standardised between 0 and 1 to be displayed on the same scale. The water level reflects the increase in precipitation."}
knitr::include_graphics(here::here("figures/matching.png"))
```


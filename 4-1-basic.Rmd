---
title: "4-examples"
output: html_document
---

# Examples {#examples}

## Australia historical maximum temperature

Global Historical Climatology Network (GHCN) provides daily climate measures from stations across the world. The dataset \code{weatherdata::historical_tmax} extracts the maximum temperature for `r nrow(weatherdata::historical_tmax)` Australian stations from GHCN with starting from year `r range(weatherdata::historical_tmax$first_year)[2]`. \code{weatherdata::historical_tmax} is already in a cubble, with \code{id} as the key, \code{date} as the index, and \code{c(longitude, latitude)} as the coordinates. This example compares the maximum temperature in two periods: 1971 - 1975 and 2016 - 2020 for stations in Victoria and New South Wales.

Stations in the two states can be subsetted by the station number: Australia GHCN station number starts with "ASN00" and followed by the [Bureau of Meteorology (BOM) station number](http://www.bom.gov.au/climate/cdo/about/site-num.shtml), where the 2nd and 3rd digit (7th and 8th in the GHCN number) define the state of the station. New South Wales stations start from 46 to 75 and Victoria stations follow from 76 to 90. Filtering Victoria and New South Wales stations is an operation in the spatial dimension and hence uses the nested form: 

```{r eval = FALSE, echo = TRUE}
tmax <- weatherdata::historical_tmax %>%
  filter(between(stringr::str_sub(id, 7, 8), 46, 90))
```

Filtering for the period 1971 ~ 1975 and 2016 ~ 2020 is an operation on the time dimension and the nested cubble needs to be switched to the long cubble by \code{stretch()}: 

```{r eval=  FALSE, echo = TRUE}
tmax <- tmax %>% 
  face_temporal() %>%
  filter(lubridate::year(date) %in% c(1971:1975, 2016:2020)) 
```

A monthly average is used for both periods to smooth the maximum temperature and it is again an operation on the time dimension:

```{r eval=  FALSE, echo = TRUE}
tmax <- tmax %>%
  group_by(month = lubridate::month(date), 
         group = as.factor(ifelse(lubridate::year(date) > 2015, 
                                  "2016 ~ 2020", "1971 ~ 1975"))) %>%
  summarise(tmax = mean(tmax, na.rm = TRUE))
```

A few stations don't have records during 1971 - 1975 and further investigation shows that while the first and last year of each series is recorded, the missing years in this period is not reported. These stations are filtered out by examining whether the summarised time series has a total of 24 months. The long cubble needs to be switched to the nested form for this spatial operation using \code{face_spatial()}: 

```{r eval = FALSE, echo = TRUE}
tmax <- tmax %>% face_spatial() %>% filter(nrow(ts) == 24) 
```

Lastly, to create a glyph map, both the major (\code{longitude}, \code{latitude}) and minor (\code{month}, \code{tmax}) coordinates need to be in the same table. Spatial variables can be moved to the long form with \code{migrate()}: 

```{r eval = FALSE, echo = TRUE}  
tmax <- tmax %>% face_temporal() %>% unfold(latitude, longitude)
```

\code{tmax} can then be supplied to \code{geom_glyph()} for the glyph map in Figure \ref{fig:basic-manip} with a station inset on the top left corner:

```{r eval = FALSE, echo = TRUE}
nsw_vic <- ozmaps::abs_ste %>% 
  filter(NAME %in% c("Victoria", "New South Wales"))

ggplot() + 
  geom_sf(data = nsw_vic, 
          fill = "transparent", color = "grey", linetype = "dotted") + 
  geom_glyph(data = tmax, 
             aes(x_major = longitude, x_minor = month, 
                 y_major = latitude, y_minor = tmax,
                 group = interaction(id, group), color = group),
             width = 1, height = 0.5) +
  ...
```

```{r basic-manip, out.width="100%", out.height="70%", fig.cap="A glyph map of the average maximum temperature by month of Victoria and New South Wales weather stations in Australia. On the top left corner is an insetted plot of station Cobar highlighted in the black box."}
knitr::include_graphics("figures/basic-manip.png")
```




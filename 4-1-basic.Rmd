---
title: "4-examples"
output: html_document
---

# Examples {#examples}

The six examples here are chosen to illustrate creating a cubble for exploring COVID data where id's need to be matched, using spatial transformations to make a glyph map of seasonal temperature changes over years, aggregating information spatially to explore precipitation patterns, matching river level data and weather station records for analysis of water supply, reading netCDF format data to reproduce a climate reanalysis plot, and the workflow to create complex interactive linked plots. 

## Victoria COVID data {#covid}

The Victoria State Government in Australia provides daily COVID information about the source and local government area (LGA) of recorded cases. This data can be used to visualise COVID spread when combined with map information available from the Australian Bureau of Statistics. Here we will use the data to demonstrate how to match sites between these two tables with \pkg{cubble} in the case of a few mismatches. The first five rows the data are printed below:  

```{r eval = FALSE}
library(tidyverse)
#https://www.coronavirus.vic.gov.au/victorian-coronavirus-covid-19-data
raw <- read_csv(here::here("data/NCOV_COVID_Cases_by_LGA_Source_20220324.csv"),
                  col_names = c("date", "postcode", "source", "lga"), skip = 1)

covid <- raw %>%
  count(date, lga, source, postcode) %>%
  filter(date >= as.Date("2022-01-01")) %>%
  filter(source == "Contact with a confirmed case") %>%
  group_by(date, lga, source) %>%
  count() %>%
  ungroup(date) %>%
  mutate(roll_mean = zoo::rollmean(n, k = 14, fill = NA)) %>%
  tsibble::as_tsibble(key = lga, index = date) %>%
  tsibble::fill_gaps(.full = TRUE)
save(covid, file = here::here("data/covid.rda"))
```

```{r}
load(here::here("data/covid.rda"))

lga <- strayr::read_absmap("lga2018") %>%
  rename(lga = lga_name_2018) %>%
  filter(state_name_2016 == "Victoria") 
```

```{r echo = TRUE}
covid |> head(5)
lga |> head(5)
```

A \code{cubble} object can be created from separate spatial and temporal tables in a list, the other arguments (\code{key}, \code{index}, and \code{coords}) are described in section \@ref(create). The function \code{as_cubble()} will automatically try to match the sites in both tables and show a warning message in case of missing information (mismatch between the sites in the two tables).

```{r echo = TRUE, warning = TRUE, message= TRUE}
cb <- as_cubble(
  list(spatial = lga, temporal = covid),
  key = lga, index = date, coords = c(cent_long, cent_lat)
  )
```

In the output above we see that this is an issue here, and we proceed to use \code{output = "unmatch"} to check which locations are concerned. Note that \pkg{cubble} will attempt to pair the unmatched sites, these are shown separately from the ones that cannot be paired.

```{r echo = TRUE}
pair <- as_cubble(
  list(spatial = lga, temporal = covid),
  key = lga, index = date, coords = c(cent_long, cent_lat),
  output = "unmatch"
  )

pair
```

This information is helpful when cleaning up the data before creating the cubble again:

```{r echo = TRUE}
lga <- lga %>%
  mutate(lga = ifelse(lga == "Kingston (C) (Vic.)", "Kingston (C)", lga),
         lga = ifelse(lga == "Latrobe (C) (Vic.)", "Latrobe (C)", lga)) %>%
  filter(!lga %in% pair$others$spatial)

covid <- covid %>% filter(!lga %in% pair$others$temporal)

cb <- as_cubble(data = list(spatial = lga, temporal = covid),
                key = lga, index = date, coords = c(cent_long, cent_lat))
```

## Australian historical maximum temperature

The Global Historical Climatology Network (GHCN) provides daily climate measures from stations across the world. The **cubble** dataset \code{weatherdata::historical_tmax} extracts the maximum temperature for `r nrow(weatherdata::historical_tmax)` Australian stations from the GHCN starting from year `r range(weatherdata::historical_tmax$first_year)[2]` and provides information also on the latitude, longitude and elevation of each of the  stations. This **cubble** data  is already cast into a \code{cubble} data object, with \code{id} as the key, \code{date} as the index, and \code{c(long, lat)} as the coordinates. The goal of this example is to compare the monthly average maximum temperature  between two periods, 1971-1975 and 2016-2020, for stations in Victoria and New South Wales.

First of all, the stations across the two states need to be subsetted from the original data  \code{weatherdata::historical_tmax}. For that, the country and the station identifiers, stored within the 11 digits of the \code{id} variable entries, need to be retrieved. The country code is located in the first 5 digits (Australia is represented by "ASN00") while the next 6 digits encode the station information following the [Australian Bureau of Meteorology (BOM)](http://www.bom.gov.au/climate/cdo/about/site-num.shtml) coding protocols. According to those, New South Wales stations correspond to entries in the range 46-75 and the Victorian stations are stored under 76-90. Filtering Victoria and New South Wales stations is a spatial operation and hence uses the \code{cubble} nested form:

```{r echo = TRUE}
tmax <- weatherdata::historical_tmax |>
  filter(between(stringr::str_sub(id, 7, 8), 46, 90))
```

and extracting the time periods 1971-1975 and 2016-2020 is a time operation and therefore the nested cubble needs to be switched to the long cubble form by \code{face_temporal()}:

```{r echo = TRUE}
tmax <- tmax |>
  face_temporal() |>
  filter(lubridate::year(date) %in% c(1971:1975, 2016:2020))
```

A monthly maximum average temperature is then calculated for both periods where \code{cubble} easily allows to compute this time operation across all the stations:

```{r echo = TRUE}
tmax <- tmax |>
  group_by(month = lubridate::month(date),
         group = as.factor(ifelse(lubridate::year(date) > 2015,
                                  "2016 ~ 2020", "1971 ~ 1975"))) |>
  summarise(tmax = mean(tmax, na.rm = TRUE))
```

Observing the results of the operation above show that a few stations do not have records during the time period 1971-1975. Further investigation shows that while the first and last year of each series for those stations are recorded, the years in between are not. Hence,  these stations are  located and filtered out by examining whether the summarised time series has 24 months. Here, the long cubble needs to be switched to the nested form to carry out this spatial operation using \code{face_spatial()}:

```{r echo = TRUE}
tmax <- tmax |> face_spatial() |> filter(nrow(ts) == 24)
```

Lastly, to create a glyph map where the series of each station are overlayed on a map of Australia, both the major (\code{long}, \code{lat}) and minor (\code{month}, \code{tmax}) coordinates defining the bounding box for the plot need to be on the same table. For that, spatial variables can be moved to the long form with \code{unfold()}:

```{r echo = TRUE}  
tmax <- tmax |> face_temporal() |> unfold(long, lat)
```

the variable storing the maximum monthly average temperatures \code{tmax} can then be supplied to \code{geom_glyph()} for the glyph map in Figure \ref{fig:basic-manip} with a station inset on the top left corner:

```{r eval = FALSE, echo = TRUE}
nsw_vic <- ozmaps::abs_ste |>
  filter(NAME %in% c("Victoria", "New South Wales"))

ggplot() +
  geom_sf(data = nsw_vic,
          fill = "transparent", color = "grey", linetype = "dotted") +
  geom_glyph(data = tmax,
             aes(x_major = longitude, x_minor = month,
                 y_major = latitude, y_minor = tmax,
                 group = interaction(id, group), color = group),
             width = 1, height = 0.5) +
  ...
```

```{r create-inset, eval = FALSE}

tmax |> filter(id == "ASN00048027") |>
  ggplot(aes(x = month,
             y = tmax,
             color = group)) +
  geom_line(size = 1.5) +
  scale_color_brewer(palette = "Dark2", guide = "none") +
  scale_x_continuous(breaks = seq(1, 12, 1), 
                     labels = c("J", "F", "M", "A", "M", "J", 
                                "J", "A", "S", "O", "N", "D")) +
  labs(x = "", y  = "Temp (C)", title = "ASN00048027: Cobar") +
  theme_bw() +
  theme(
    aspect.ratio = 0.3,
    axis.text = element_text(size = 20),
    title =  element_text(size = 20)
  )

#ggsave(filename = here::here("figures/basic-manip-inset.png"), width = 7)
```


```{r basic-manip, fig.height = 7, fig.width = 10, fig.cap="A glyph map of the average maximum temperature by month for parts of Victoria and New South Wales weather stations in Australia for two five year periods (1971-1975, 2016-2020). An inset (top left) showing detail is the station Cobar (highlighted by black rectangle). The mothly trend is similar at all locations (low in the winter, high in the summer), and small increased temperatures, particularly in late summer can be seen at most stations."}
nsw_vic <- ozmaps::abs_ste |> filter(NAME %in% c("Victoria", "New South Wales"))

p1 <- ggplot() + 
  geom_sf(data = nsw_vic, fill = "grey95", color = "white") + 
  geom_glyph(data = tmax, 
             aes(x_major = long, x_minor = month, 
                 y_major = lat, y_minor = tmax,
                 group = interaction(id, group), 
                 color = group),
             width = 1, height = 0.5) +
  scale_color_brewer("", palette = "Dark2") + 
  theme_bw() + 
  coord_sf(xlim = c(141, 154), ylim = c(-36, -29)) + 
  ggthemes::theme_map() +
  theme(legend.position = "bottom") +
  labs(x = "Longitude", y = "Latitude")

box_df <- tmax |> face_spatial() |> filter(id == "ASN00048027")
single <- tibble::tibble(img = here::here("figures/basic-manip-inset.png"))

p1 +
  geom_rect(data = box_df,
            aes(xmin = long - 0.6, xmax = long + 0.6,
                ymin = lat - 0.12, ymax = lat + 0.35),
            fill = "transparent", color = "black") +
  ggimg::geom_point_img(
    data = single, aes(x = 143.7, y = -30, img = img), size = 6)

```

---
title: "4-2-aggre"
output: pdf_document
---

## Australia precipitation pattern in 2020 {#precip}

In the previous example, there has already been some overlapping of the glyphs for a few stations near (151E, 34S) and (152E, 33S), which is a problem when mapping more stations at the national level. Aggregation can be helpful in grouping series into clusters before visualising the clusters with a glyph map. This example shows how to organise data at both levels with \code{switch_key()}.

\code{weatherdata::climate_full}, also extracted from the GHCN, records daily precipitation and maximum/minimum temperature for `r nrow(weatherdata::climate_full)` stations in Australia from 2016 to 2020. A simple $k$-means algorithm based on the distance matrix is used to create 20 clusters. The dataset \code{station_nested} is a nested cubble with a cluster column indicating the group to which each station belongs. More advanced clustering algorithms can be used for other applications, as long as there is a mapping from each station to a cluster.

```{r}
load(here::here("data/station_nested.rda"))
```

```{r echo = TRUE, eval = FALSE}
station_nested <- weatherdata::climate_full |>
  mutate(cluster = ...)
```

To create a group-level cubble, use \code{switch_key()} with the new key variable, \code{cluster}:

```{r echo = TRUE}
cluster_nested <- station_nested |> switch_key(cluster)
```

With the group-level cubble, \code{get_centroid()} is useful to compute the centroid of each cluster, which will be used as the major axis for the glyph map later:

```{r eval = FALSE, echo = TRUE}
cluster_nested <- cluster_nested |> get_centroid()
```

Long form cubble at both levels can be accessed through stretching the nested form and with access to both station and cluster-level cubbles, various plots can be made to understand the cluster. Figure \ref{fig:basic-agg} shows two example plots that can be made with this data. Subplot A is a glyph map made with the cluster level cubble in the long form and subplot B inspects the station membership of each cluster using the station level cubble in the nested form.

```{r basic-agg, out.width="100%", fig.cap="Profile of aggregated precipitation from 639 weather stations in Australia. Subplot A shows the glyph map of the weekly averaged precipitation of each cluster. The group number is printed in the middle of the y minor axis and can be used as a reference line to read the magnitude. Subplot B shows the station membership of each cluster."}
knitr::include_graphics(here::here("figures/basic-agg.png"))
```

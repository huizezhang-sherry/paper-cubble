---
title: "3-advanced"
output: pdf_document
---

# Advanced features/ considerations

## Hierarchical structure

Spatial locations can have further grouping structure either in nature (i.e. countries are nested in continents), or calculated by some clustering algorithms. Rather than investigate the read from individual locations, group character summarised from multiple locations can give a clearer picture of the local dynamic. In cubble, `switch_key()` can be used to create a new level of grouping of spatial location by specifying a clustering variable. Figure \ref{fig:illu-hier} illustrates the relationship of cubbles at site and cluster level, in both the long and nested form. By specifying `cluster_nested <- station_nested %>% switch_key(key = cluster)`, the cubble re-defines the cubble key from `id` in `station_nested` to `cluster` in `cluster_nested`. All the spatial variables variant to `cluster` are now nested into a `.val` column and cluster level variables can be computed in the same fashion as station level variables in `station_nested`. Following the same principal of `stretch`, the long form cluster level cubble expands the time series variables with both indices: `cluster` and `id`. All the cluster level variables are stored separately for recovering the nested from from the long form.

```{r illu-hier, echo = FALSE, fig.align="center", out.width = "100%", fig.cap = "Relationship between the station and cluster level cubble in both long and nested form."}
knitr::include_graphics(here::here("figures/diagram-keynotes/diagram-keynotes.003.png"))
```

## Data fusion and matching

Data fusion is a process that consider combining multiple multiple data sources. 
widely used in remote sensing 

Meteorological and hydrological data have been matched in the applied studies in the literature to understand drought, ... [ref]. To be a valid pair of matching, the matched pair from different data sources need to be spatially close to each other and temporally [...]. [
can also think about matching as a form of correlation between series from a statistics point of view.] Cubble has `match_sites()` to match data from multiple sources spatially and temporally. `match_sites()` first matches the two data source spatially through computing the distance [more details on spatial matching - keep one, max dist] and then computes the number of peaks in the two time series that fall within in a fixed length window. Figure \ref{fig:illu-matching} illustrates the temporal matching. With temporal matching, a `temporal_var_to_match` needs to be first specified. Another parameter needs to be specified is `temporal_independent` which determines the series for construct the interval. In Figure \ref{fig:illu-matching}, series A moves before series a and an interval is constructed after the three highest peaks. Then the highest three peak from series a is identified and two of them falls into the interval constructed. There are two matches here at Time 5 and 27.

```{r illu-matching, out.width="100%", out.height="30%", fig.cap="sdfasdf"}
knitr::include_graphics("figures/illu-matching.png")
```

Several arguments are available in `match_sites()` to adjust the matching: 

 - `spatial_n_keep`: the number of matching to keep
 - `spatial_dist_max`: the maximum distance allowed between matched pair
 - `temporal_n_highest`: the number of highest peak used for temporal matching
 - `temporal_window`: the temporal window 
 - `temporal_min_match`: the minimum number of peak matching for temporal matching

## Interactive graphics

<!-- Interactive graphics can listen to users' actions on the plot to provide additional information that facilitates data exploration. This is a useful technique for spatio-temporal data since users can zoom or pan the map to view the local and global structure of the map; use tooltips or popups to query more information about a graphic element; or highlight points to explore its linked views in other plots. In the R community, many implementations have been developed to connect \proglang{R} to \proglang{javascript} to create interactive graphics. In relation to spatio, temporal, and spatio-temporal data, the general purpose packages \pkg{plotly} [@plotly] and \pkg{leaflet} [@leaflet] realise various interactive actions through their corresponding javascript libraries. \pkg{crosstalk} [@crosstalk] and \pkg{tsibbletalk} [@tsibbletalk] implement brushed linking between htmlwidgets. \pkg{ggiraph} [@ggiraph] enables tooltip, self-linking, and customised actions specified through its own \proglang{javascript}. -->

<!-- While many graphic implementations present worked examples to illustrate the usage of the package, few documents the underlying pipeline that transforms the raw data step-by-step to the final view on the screen. There have been some early work in building the data pipeline for (interactive) graphics [@buja1988elements; @buja1996interactive;  @sutherland2000orca] and more recent discussions include @wickham2009plumbing, @xie2014reactive, and @cheng2016enabling. -->

The cubble structure fits in naturally with the interactive graphic pipeline discussed in the literature [@buja1988elements; @buja1996interactive;  @sutherland2000orca; @xie2014reactive; @cheng2016enabling]. Diagram \ref{fig:illu-interactive} illustrates how linking works with the two forms in a cubble, where a time series plot is created with the long cubble and a map is created with the nested cubble. When a user action is captured from the map, the site will be activated in the nested cubble. Then, the nested cubble will communicate to the long cubble to activate all the observations with the same `id`. The long cubble will then highlight the  activated series in the time series plot. 

The linking is also available from the time series plot to the map. The selection on the time series is through selecting the point on the time series and once a point is selected, it will be activated in the long cubble. All the observations that share the same `id`,  either in the long and nested cubble, are then activated. This includes other points in the same time series in the long cubble and the corresponding observation of site in the nested cubble. These activated observations will then being reflected in the updated plots and Diagram \ref{fig:illu-interactive-2} in the Appendix illustrates this process. 

```{r illu-interactive, echo = FALSE, fig.align="center", out.height="40%", out.width = "100%", fig.cap = "demon interactivity"}
knitr::include_graphics(here::here("figures/diagram-keynotes/diagram-keynotes.004.png"))
```

## Glyph map

Glyph map [@Wickham2012-yr] plots the time series as single glyph on the map. 
<!-- Variation of glyph maps has been developed to visualise uncertainty in **Visumap** [@Lucchesi2021] and deal with irregular local grid [@Beecham2021-vk].  -->
In \proglang{R}, `GGally` implements the glyph map through the `glyphs()` function, which outputs a data frame with calculated position (`gx`, `gy`, `gid`) of each point on the time series given the major and minor xy variable using linear algebra (Equation 1 and 2 in @Wickham2012-yr). The data can then be piped into `ggplot` to create the glyph map: 

```{r eval = FALSE, echo = TRUE}
library(ggplot2)
gly <- glyphs(data, 
              x_major = ..., x_minor = ..., 
              y_major = ..., y_minor = ..., ...)

ggplot(gly, aes(gx, gy, group = gid)) + 
  geom_path() 
```

While this calculation can be seen as part of the `setup_data()` in a `ggproto`. A re-implementation of the glyph map as `GeomGlyph` has been made in `cubble` to create the glyph map with `geom_glyph`:

```{r eval = FALSE, echo = TRUE}
ggplot(data = data) +
  geom_glyph(aes(x_major = ..., x_minor = ..., 
                 y_major = ..., y_minor = ...))
```

Polar glyph map can be specify as a parameter, `polar = TRUE`, in the `geom_glyph()`, along with `width` and `height` in either absolute or relative value. Global and local scale can also be controlled by the parameter `global_rescale`, which default to `TRUE`. Reference box and line can be added with separate `geom_glyph_box()` and `geom_glyph_line()`.

---
title: "4-4-netcdf"
output: pdf_document
---


## ERA5: climate reanalysis data

NetCDF (Network Common Data Form) is a data format commonly used in climatology community to deliver global mapping of atmosphere, ocean, and land. It has two major components: dimension to define the spatiotemporal grid (longitude, latitude, and time) and variable which populates the defined grid. Attributes are usually associated with dimension and variable in the NetCDF format data and a [metadata convention for climate and forecast](http://cfconventions.org/) has been designed to standardise this data format. Current packages on manipulating NetCDF data in R include a high-level R interface: `ncdf4`[@ncdf4], a low-level interface that calls C-interface: `RNetCDF`[@rnetcdf; @michna2013rnetcdf], and a tidyverse implementation: `tidync`[@tidync].

Cubble provides an `as_cubble()` method to coerce the `ncdf4` class from the `ncdf4` package into a `cubble`. It maps each combination of latitude and longitude into a unit. 

```{r echo = TRUE, eval = FALSE}
# read in the .nc file as a ncdf4 class
raw <- ncdf4::nc_open(here::here("data/era5-pressure.nc"))

# convert the variable q and z in the ncdf4 into a cubble
dt <- as_cubble(raw, vars = c("q", "z"))
```

Since each combination of latitude and longitude grid is regarded as a site, the number of site quickly goes up when mapping on a global scale. 

  - For a southern hemisphere bounding box of [-5, -180, -90, 180], 491,040 id, 8 timestamp, 15MB -> 11 sec
  - For an Australia bounding box of [-12, 115, -43, 153], 19125 id, 1,827 times tamp, 133 MB -> 1 mins . 
  
This shows a computation on the time dimension is cheaper than the spatial dimension. Argument `long_range` and `lat_range` are available to subset to a looser grid when reading in global level resolution. `era5-pressure.nc` has 0.25 degree resolution and to read in the data in whole degree, use:

```{r eval = FALSE, echo = TRUE}
dt <- as_cubble(raw, vars = c("q", "z"), 
                long_range = seq(-180, 180, 1), 
                lat_range = seq(-90, 90, 1))
```


Here an example in Figure \ref{fig:netcdf} is given to reproduce Figure 19 in @hersbach2020era5 from the ERA5 data. ERA5 data [@hersbach2020era5] is the latest reanalysis of global atmosphere, land surface, and ocean waves from 1950 onwards and is available in the NetCDF format. It can be directly downloaded from the [Copernicus Climate Data Store (CDS)](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels?tab=overview) website or programmatically via R package `ecmwfr`[@ecwmfr]. Variable Specific humidity and geopotential are queried on the 10 hPa pressure level for four dates: 2002-09-22, 2002-09-26, 2002-09-30, and 2002-10-04. Readers who are interested in the details of  can refer to @simmons2020global and @simmons2005ecmwf.

```{r netcdf, out.width="100%", fig.cap = "sdf"}
knitr::include_graphics(here::here("figures/netcdf.png"))
```


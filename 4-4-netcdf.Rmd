---
title: "4-4-netcdf"
output: pdf_document
---


## ERA5: climate reanalysis data

The ERA5 reanalysis [@hersbach2020era5] provides hourly estimates of atmospheric, land and oceanic climate variables on a global scale. The hourly pressure level data in the NetCDF format can be downloaded from Copernicus Climate Data Store (CDS) [@cds] or via the \pkg{ecmwfr} package [@ecwmfr]. This example reproduces the row created from ERA5 reanalysis data shown in Figure 19 by @hersbach2020era5. The plot shows the southern polar vortex splitting into two on 2002-09-26, and further splitting into four on 2002-10-04. Further explanation of why this is interesting can be found in the figure source, and also in @simmons2020global and @simmons2005ecmwf.

To work with NetCDF data in R, several packages are available, including \code{ncdf4}, \code{RNetCDF}, and \code{tidync}. The following code converts a NetCDF object of class \code{ncdf4} into a cubble object:

```{r echo = TRUE}
raw <- ncdf4::nc_open(here::here("data/era5-pressure.nc"))
```

Analysts can extract a subset of the NetCDF data with the arguments \code{vars}, \code{long_range} and \code{lat_range}. In this example, the variables q (specific humidity) and z (geopotential) are selected and the coordinates are subsetted to every degree in longitude and latitude: 

```{r echo = TRUE}
(dt <- as_cubble(raw, vars = c("q", "z"),
                 long_range = seq(-180, 180, 1), lat_range = seq(-88, -15, 1)))
```

Once the NetCDF data is coerced into a cubble object, subsequent analysis can be conducted to filter on the date of interest, scale the variable specific humidity and create visualisation in ggplot as in Figure \ref{fig:netcdf}.

```{r netcdf, out.width="100%", fig.height = 4, fig.width = 10, fig.cap = "A reproduction of the second row (ERA5 data) of Figure 19 in Hersbach et al (2020) to illustrate the break-up of sourthern polar vortex in late September and early October 2002. The polar vortex, signalled by the high specific humidity, splits into two on 2002-09-26 and further splits into four on 2002-10-04."}
date <- c("2002-09-22", "2002-09-26", "2002-09-30", "2002-10-04") |> as.Date()
res <- dt |> 
  face_temporal() |> 
  filter(lubridate::date(time) %in% date) |>
  unfold(long, lat) |> 
  mutate(q = q* 10^6)

con <- rnaturalearth::ne_coastline("small", returnclass = "sf")
box <- st_bbox(c(xmin = -180, ymin = -90, xmax = 180, ymax = -15), crs = st_crs(con)) 
sf::sf_use_s2(FALSE)
country <- con %>% st_geometry() %>% 
  sf::st_crop(box) |> 
  sf::st_cast("MULTILINESTRING")

res |> 
  ggplot() +
  # q for specific humidity
  geom_point(aes(x = long, y = lat, color = q)) + 
  #geom_tile(aes(x = long, y = lat, fill = q), color = "transparent") +
  # z for geopotential
  geom_contour(data = res, aes(x = long, y = lat, z = z),
               color = "grey20", binwidth = 4000, linewidth = 0.5) +
  geom_sf(data = country , alpha = 0.5, fill = "transparent", color = "lightgreen") +
  coord_sf(
    crs = "+proj=stere +lat_0=-90 +lon_0=-180 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs", default_crs = sf::st_crs(4326), clip = "off") +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank()) +
  facet_wrap(vars(as.Date(time)), nrow = 1)+  
  colorspace::scale_color_continuous_sequential("Purple-Yellow", name = "Specific humidity") + 
  theme(legend.text = element_text(size = 13),
        legend.title = element_text(size = 13)) + 
  labs(x ="", y = "")
```


```{r eval = FALSE}
# prepare data/era5-pressure.nc
library(ecmwfr)
my_request <- list(
  product_type = "reanalysis",
  format = "netcdf",
  pressure_level = "10",
  year = "2002",
  month = c("09", "10"),
  day = c("04", "22", "26", "30"),
  time = "00:00",
  area = c(-15, -180, -90, 180),
  variable = c("specific_humidity", 'geopotential'),
  dataset_short_name = "reanalysis-era5-pressure-levels",
  target = "era5-pressure.nc"
)
# 
# # here you need to create an account on Climate Data Store 
# # at https://cds.climate.copernicus.eu/cdsapp#!/home) to obtain the user ID and API key
# # then set up the with ecmwfr::wf_set_key(user, key, service = "cds")
# # the user below is the same `user` in the setup line
wf_request(
  user = "113339",
  request = my_request,
  transfer = TRUE,
  path = here::here("data/"))
```
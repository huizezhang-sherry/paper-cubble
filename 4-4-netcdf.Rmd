---
title: "4-4-netcdf"
output: pdf_document
---


## ERA5: climate reanalysis data

Figure \ref{fig:netcdf} reproduces the ERA5 data row of Figure 19 in @hersbach2020era5. Here we explain how this would be done using cubble. The plots show that the southern polar vortex splits into two on 2002-09-26 and further splits into four on 2002-10-04. Further explanation of why this is interesting can be found in the figure source, and also @simmons2020global, @simmons2005ecmwf.

The ERA5 data [@hersbach2020era5] provides hourly estimates across the Earth for atmospheric, land and oceanic climate variables. The data is available in the NetCDF format from the European Centre for Medium-Range Weather Forecasts (ECMWF). It can be directly downloaded from [Copernicus Climate Data Store (CDS)](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels?tab=overview) website or via the R package \pkg{ecmwfr} [@ecwmfr]. 

For the reproduction, we focus on the \code{era5-pressure} data, hourly pressure levels from 1970 to present, with the *specific humidity* and *geopotential*. <!--Here we specifically look at the information  contained on the variables *specific humidity* measuring the mass of water vapor per kilogram of moist air  and the *geopotential* variable recording the gravitational potential energy of a unit mass, at a particular location, relative to mean sea level.--> 

<!--The goal of this example is to reproduce the break-up of the southern polar vortex that happened in late September and early October in 2002 in the stratosphere in the Southern Hemisphere. Therefore, we filter data corresponding to the Southern Hemisphere and restrict our analysis to four dates: 2002-09-22, 2002-09-26, 2002-09-30, and 2002-10-04.--> The downloaded netcdf data is read into R using the \code{ncdf4} package, and converted to a \code{cubble}:

```{r eval = FALSE, echo = TRUE}
raw <- ncdf4::nc_open(here::here("data/era5-pressure.nc"))
dt <- as_cubble(raw, vars = c("q", "z"))
```

<!-- Figure \ref{fig:netcdf} reproduces the ERA5 data row of Figure 19 in @hersbach2020era5. It shows the southern polar vortex splits into two on 2002-09-26 and further splits into four on 2002-10-04 in the stratosphere. Readers interested in the analysis of this figure can refer to @hersbach2020era5, @simmons2020global, and @simmons2005ecmwf for more details.-->

Creating the plot requires making transformations on time, unfolding the data for computing the statistic of interest, which is plotted directly as a contour plot with \code{ggplot}. Code is provided to accomplish this in the supplementary material.

```{r netcdf, out.width="100%", fig.cap = "A reproduction of the second row (ERA5 data) of Figure 19 in Hersbach et al (2020) to illustrate the break-up of sourthern polar vortex in late September and early October 2002. The polar vortex, signalled by the high speicfic humidity, splits into two on 2002-09-26 and furthers split into four on 2002-10-04."}
knitr::include_graphics(here::here("figures/netcdf.png"))
```
